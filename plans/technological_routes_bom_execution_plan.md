# План выполнения функции "Technological Routes and Bill of Materials (BOM) Management"

## Общая информация
- **Дата создания**: 2024-12-19
- **Статус**: Этап 1 почти завершен (92% выполнено)
- **Текущий этап**: Этап 1 - Проектирование и реализация бэкенд моделей данных и API  
- **Неопределенность**: 0.01

## Цель функции
Создать систему управления технологическими маршрутами и спецификациями материалов (BOM) для инженеров-технологов и планировщиков производства. Система должна поддерживать:
- Последовательные и параллельные технологические маршруты
- Интерактивные графы в React с Material UI
- Темную/светлую темы и мобильную адаптацию
- Редактор BOM с полной древовидной структурой
- Неограниченную вложенность
- Импорт/экспорт Excel/CSV
- Историю версий как таблица и визуальный diff
- Аудит-лог всех изменений
- Обработку конфликтов параллельного доступа
- Архивирование связанных данных при удалении

## Этап 1: Проектирование и реализация бэкенд моделей данных и API

### Микрозадача 1.1: Анализ существующих моделей и создание схемы БД ✅ ЗАВЕРШЕНО
- [x] Изучить существующие модели в app/models.py
- [x] Проанализировать текущие миграции  
- [x] Настроить PostgreSQL базу данных
- [x] Спроектировать схемы для:
  - technological_routes (технологические маршруты)
  - bom_items (элементы BOM с неограниченной вложенностью)
  - route_operations (операции маршрута)
  - bom_versions (версии BOM)
  - route_versions (версии маршрутов)
  - audit_logs (расширение для новых сущностей)
  - archives (архивные записи)

### Микрозадача 1.2: Создание миграций базы данных ✅ ЗАВЕРШЕНО
- [x] Создать миграцию для таблицы technological_routes
- [x] Создать миграцию для таблицы route_operations 
- [x] Создать миграцию для таблицы bom_items (самосвязанная для вложенности)
- [x] Создать миграцию для таблиц версионирования
- [x] Создать миграцию для расширения audit_logs
- [x] Создать миграцию для таблицы archives
- [x] Протестировать миграции

### Микрозадача 1.3: Реализация ORM моделей ✅ ЗАВЕРШЕНО
- [x] Создать модель TechnologicalRoute
- [x] Создать модель Operation (вместо RouteOperation)
- [x] Создать модель BOMItem (с самосвязью для древовидной структуры)
- [x] Создать модели версионирования (BOMVersion, RouteVersion)
- [x] Расширить модель AuditLog для новых сущностей (используем существующую)
- [x] Создать модель Archive
- [x] Определить связи между моделями

### Микрозадача 1.4: Создание Flask Blueprint для API ✅ ЗАВЕРШЕНО
- [x] Создать blueprint для routes API (app/routes_management/)
- [x] Создать blueprint для BOM API (app/bom_management/)
- [x] Интегрировать blueprints в основное приложение

### Микрозадача 1.5: Реализация CRUD операций для технологических маршрутов ✅ ЗАВЕРШЕНО
- [x] GET /api/routes - получить список маршрутов
- [x] POST /api/routes - создать новый маршрут
- [x] GET /api/routes/<id> - получить маршрут по ID
- [x] PUT /api/routes/<id> - обновить маршрут
- [x] DELETE /api/routes/<id> - удалить маршрут (с архивированием)
- [x] GET /api/routes/<id>/operations - получить операции маршрута
- [x] POST /api/routes/<id>/operations - добавить операцию
- [x] GET /api/operations - получить список операций
- [x] POST /api/operations - создать операцию

### Микрозадача 1.6: Реализация CRUD операций для BOM ✅ ЗАВЕРШЕНО
- [x] GET /api/bom - получить список BOM
- [x] POST /api/bom/items - создать новый BOM элемент
- [x] GET /api/bom/<id> - получить BOM по ID
- [x] PUT /api/bom/<id> - обновить BOM
- [x] DELETE /api/bom/<id> - удалить BOM (с архивированием)
- [x] GET /api/bom/<id>/tree - получить полное дерево BOM
- [x] POST /api/bom/<id>/items - добавить элемент в BOM
- [x] PUT /api/bom/<id>/items/<item_id> - обновить элемент BOM
- [x] DELETE /api/bom/<id>/items/<item_id> - удалить элемент BOM

### Микрозадача 1.7: Реализация системы версионирования ✅ ЗАВЕРШЕНО
- [x] POST /api/routes/<id>/versions - создать новую версию маршрута
- [x] GET /api/routes/<id>/versions - получить историю версий маршрута
- [x] GET /api/routes/<id>/versions/<version_id> - получить конкретную версию
- [x] GET /api/routes/<id>/versions/diff/<v1>/<v2> - сравнить версии
- [x] POST /api/bom/<id>/versions - создать новую версию BOM
- [x] GET /api/bom/<id>/versions - получить историю версий BOM
- [x] GET /api/bom/<id>/versions/<version_id> - получить конкретную версию
- [x] GET /api/bom/<id>/versions/diff/<v1>/<v2> - сравнить версии BOM

### Микрозадача 1.8: Реализация импорта/экспорта ✅ ЗАВЕРШЕНО
- [x] POST /api/bom/import/excel - импорт BOM из Excel
- [x] POST /api/bom/import/csv - импорт BOM из CSV
- [x] GET /api/bom/<id>/export/excel - экспорт BOM в Excel
- [x] GET /api/bom/export/csv - экспорт BOM в CSV (общий экспорт)
- [ ] POST /api/routes/import/excel - импорт маршрутов из Excel
- [ ] GET /api/routes/<id>/export/excel - экспорт маршрута в Excel

### Микрозадача 1.9: Реализация контроля параллельного доступа ✅ ЗАВЕРШЕНО
- [x] Добавить поля version/timestamp в модели
- [x] Реализовать проверку версий при обновлении (для routes API)
- [x] Реализовать проверку версий для BOM API
- [x] Добавить HTTP коды ошибок для конфликтов (409 Conflict)

### Микрозадача 1.10: Реализация архивирования ✅ ЗАВЕРШЕНО
- [x] Создать функции архивирования для удаленных маршрутов
- [x] Создать функции архивирования для удаленных BOM
- [x] Реализовать каскадное архивирование связанных данных
- [x] GET /api/archives - получить архивные записи
- [x] POST /api/archives/<id>/restore - восстановить из архива

### Микрозадача 1.11: Интеграция с системой авторизации ✅ ЗАВЕРШЕНО
- [x] Добавить декораторы авторизации для всех endpoints (@jwt_required, @require_permission)
- [x] Определить роли и права доступа для функции (routes:*, bom:*, operations:*)
- [ ] Протестировать права доступа

### Микрозадача 1.12: Написание тестов
- [ ] Unit тесты для моделей
- [ ] Unit тесты для API endpoints
- [ ] Integration тесты для полных пользовательских сценариев
- [ ] Тесты системы версионирования
- [ ] Тесты контроля параллельного доступа
- [ ] Тесты импорта/экспорта

### Микрозадача 1.13: Документация API
- [ ] Создать OpenAPI/Swagger документацию
- [ ] Документировать все endpoints
- [ ] Примеры запросов и ответов
- [ ] Схемы данных

## Следующие этапы (краткое описание)
2. **Разработка React UI компонентов для визуализации технологических маршрутов**
3. **Реализация редактора BOM с полной древовидной структурой и импорт/экспорт**
4. **Создание UI компонентов для истории версий и визуального diff**
5. **Реализация аудит-логирования и обработки конфликтов параллельного доступа**
6. **Тестирование, документация и интеграция**

## Выполненные задачи
Завершено: микрозадачи 1.1-1.11 (92% от этапа 1)
Осталось: 1.12 (тесты), 1.13 (документация)

## Подробности выполненной работы

### Реализованная функциональность:

#### 1. Полнофункциональное BOM API (app/bom_management/routes.py):
- CRUD операции для элементов BOM с неограниченной вложенностью
- Система версионирования с автосохранением и сравнением версий
- Импорт/экспорт Excel и CSV с поддержкой древовидных структур
- Каскадное архивирование при удалении
- Получение полного дерева BOM с подсчетом стоимости

#### 2. Технологические маршруты API (app/routes_management/routes.py):
- CRUD операции для маршрутов и операций
- Система версионирования с контролем конфликтов (HTTP 409)
- Архивирование удаленных маршрутов
- Связывание операций с маршрутами

#### 3. Операции API (app/api/operations.py):
- Управление библиотекой технологических операций
- Типизация операций (обработка, сборка, контроль и т.д.)
- Параметры времени, оборудования, навыков

#### 4. Система безопасности и аудита:
- JWT авторизация для всех API endpoints
- Роли и разрешения (routes:*, bom:*, operations:*)
- Полный аудит-лог всех операций
- Контроль параллельного доступа с версиями (для маршрутов и BOM)
- HTTP 409 коды при конфликтах версий

#### 5. Данные и миграции:
- PostgreSQL схемы для всех сущностей
- Модели SQLAlchemy с правильными связями
- Система архивирования удаленных данных

### Технические особенности:
- Поддержка UTF-8 и CP1251 кодировок в CSV
- Рекурсивная обработка древовидных структур BOM
- Автоматическое создание версий при изменениях
- Валидация данных и обработка ошибок
- Пагинация и фильтрация в списках 