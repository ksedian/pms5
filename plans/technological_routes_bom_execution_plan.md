# План выполнения функции "Technological Routes and Bill of Materials (BOM) Management"

## Общая информация
- **Дата создания**: $(date)
- **Статус**: В процессе выполнения
- **Текущий этап**: Этап 1 - Проектирование и реализация бэкенд моделей данных и API
- **Неопределенность**: 0.05

## Цель функции
Создать систему управления технологическими маршрутами и спецификациями материалов (BOM) для инженеров-технологов и планировщиков производства. Система должна поддерживать:
- Последовательные и параллельные технологические маршруты
- Интерактивные графы в React с Material UI
- Темную/светлую темы и мобильную адаптацию
- Редактор BOM с полной древовидной структурой
- Неограниченную вложенность
- Импорт/экспорт Excel/CSV
- Историю версий как таблица и визуальный diff
- Аудит-лог всех изменений
- Обработку конфликтов параллельного доступа
- Архивирование связанных данных при удалении

## Этап 1: Проектирование и реализация бэкенд моделей данных и API

### Микрозадача 1.1: Анализ существующих моделей и создание схемы БД ✅ ЗАВЕРШЕНО
- [x] Изучить существующие модели в app/models.py
- [x] Проанализировать текущие миграции  
- [x] Настроить PostgreSQL базу данных
- [x] Спроектировать схемы для:
  - technological_routes (технологические маршруты)
  - bom_items (элементы BOM с неограниченной вложенностью)
  - route_operations (операции маршрута)
  - bom_versions (версии BOM)
  - route_versions (версии маршрутов)
  - audit_logs (расширение для новых сущностей)
  - archives (архивные записи)

### Микрозадача 1.2: Создание миграций базы данных ✅ ЗАВЕРШЕНО
- [x] Создать миграцию для таблицы technological_routes
- [x] Создать миграцию для таблицы route_operations 
- [x] Создать миграцию для таблицы bom_items (самосвязанная для вложенности)
- [x] Создать миграцию для таблиц версионирования
- [x] Создать миграцию для расширения audit_logs
- [x] Создать миграцию для таблицы archives
- [x] Протестировать миграции

### Микрозадача 1.3: Реализация ORM моделей ✅ ЗАВЕРШЕНО
- [x] Создать модель TechnologicalRoute
- [x] Создать модель Operation (вместо RouteOperation)
- [x] Создать модель BOMItem (с самосвязью для древовидной структуры)
- [x] Создать модели версионирования (BOMVersion, RouteVersion)
- [x] Расширить модель AuditLog для новых сущностей (используем существующую)
- [x] Создать модель Archive
- [x] Определить связи между моделями

### Микрозадача 1.4: Создание Flask Blueprint для API ✅ ЗАВЕРШЕНО
- [x] Создать blueprint для routes API (app/routes_management/)
- [x] Создать blueprint для BOM API (app/bom_management/)
- [x] Интегрировать blueprints в основное приложение

### Микрозадача 1.5: Реализация CRUD операций для технологических маршрутов ✅ ЗАВЕРШЕНО
- [x] GET /api/routes - получить список маршрутов
- [x] POST /api/routes - создать новый маршрут
- [x] GET /api/routes/<id> - получить маршрут по ID
- [x] PUT /api/routes/<id> - обновить маршрут
- [x] DELETE /api/routes/<id> - удалить маршрут (с архивированием)
- [x] GET /api/routes/<id>/operations - получить операции маршрута
- [x] POST /api/routes/<id>/operations - добавить операцию
- [x] GET /api/operations - получить список операций
- [x] POST /api/operations - создать операцию

### Микрозадача 1.6: Реализация CRUD операций для BOM
- [ ] GET /api/bom - получить список BOM
- [ ] POST /api/bom - создать новый BOM
- [ ] GET /api/bom/<id> - получить BOM по ID
- [ ] PUT /api/bom/<id> - обновить BOM
- [ ] DELETE /api/bom/<id> - удалить BOM (с архивированием)
- [ ] GET /api/bom/<id>/tree - получить полное дерево BOM
- [ ] POST /api/bom/<id>/items - добавить элемент в BOM
- [ ] PUT /api/bom/<id>/items/<item_id> - обновить элемент BOM
- [ ] DELETE /api/bom/<id>/items/<item_id> - удалить элемент BOM

### Микрозадача 1.7: Реализация системы версионирования
- [ ] POST /api/routes/<id>/versions - создать новую версию маршрута
- [ ] GET /api/routes/<id>/versions - получить историю версий маршрута
- [ ] GET /api/routes/<id>/versions/<version_id> - получить конкретную версию
- [ ] GET /api/routes/<id>/versions/diff/<v1>/<v2> - сравнить версии
- [ ] POST /api/bom/<id>/versions - создать новую версию BOM
- [ ] GET /api/bom/<id>/versions - получить историю версий BOM
- [ ] GET /api/bom/<id>/versions/<version_id> - получить конкретную версию
- [ ] GET /api/bom/<id>/versions/diff/<v1>/<v2> - сравнить версии BOM

### Микрозадача 1.8: Реализация импорта/экспорта
- [ ] POST /api/bom/import/excel - импорт BOM из Excel
- [ ] POST /api/bom/import/csv - импорт BOM из CSV
- [ ] GET /api/bom/<id>/export/excel - экспорт BOM в Excel
- [ ] GET /api/bom/<id>/export/csv - экспорт BOM в CSV
- [ ] POST /api/routes/import/excel - импорт маршрутов из Excel
- [ ] GET /api/routes/<id>/export/excel - экспорт маршрута в Excel

### Микрозадача 1.9: Реализация контроля параллельного доступа
- [ ] Добавить поля version/timestamp в модели
- [ ] Реализовать проверку версий при обновлении
- [ ] Создать middleware для обработки конфликтов версий
- [ ] Добавить HTTP коды ошибок для конфликтов (409 Conflict)

### Микрозадача 1.10: Реализация архивирования
- [ ] Создать функции архивирования для удаленных маршрутов
- [ ] Создать функции архивирования для удаленных BOM
- [ ] Реализовать каскадное архивирование связанных данных
- [ ] GET /api/archives - получить архивные записи
- [ ] POST /api/archives/<id>/restore - восстановить из архива

### Микрозадача 1.11: Интеграция с системой авторизации
- [ ] Добавить декораторы авторизации для всех endpoints
- [ ] Определить роли и права доступа для функции
- [ ] Протестировать права доступа

### Микрозадача 1.12: Написание тестов
- [ ] Unit тесты для моделей
- [ ] Unit тесты для API endpoints
- [ ] Integration тесты для полных пользовательских сценариев
- [ ] Тесты системы версионирования
- [ ] Тесты контроля параллельного доступа
- [ ] Тесты импорта/экспорта

### Микрозадача 1.13: Документация API
- [ ] Создать OpenAPI/Swagger документацию
- [ ] Документировать все endpoints
- [ ] Примеры запросов и ответов
- [ ] Схемы данных

## Следующие этапы (краткое описание)
2. **Разработка React UI компонентов для визуализации технологических маршрутов**
3. **Реализация редактора BOM с полной древовидной структурой и импорт/экспорт**
4. **Создание UI компонентов для истории версий и визуального diff**
5. **Реализация аудит-логирования и обработки конфликтов параллельного доступа**
6. **Тестирование, документация и интеграция**

## Выполненные задачи
(Будут отмечаться по мере выполнения)

## Подробности выполненной работы
(Будут добавляться по мере реализации) 